#! /bin/bash

# Copyright 2014 Interactive Motion Technologies, Inc.
# Watertown, MA, USA
# http://www.interactive-motion.com
# All rights reserved

# usbcopy - copy patient data from $THERAPIST_HOME to a usb stick.
# takes a list of patient folder names.

# the quoting inside the here document is subtle.
# the $? and $ret need to be quoted so that it happens inside the here doc.
# the $* and stuff happens outide the here doc.

rm -f /tmp/usbcopy*
COPY=$(mktemp /tmp/usbcopyXXXXX)
NOWDATE=$(date +%F)
ME=$USER
STICK="$(echo /media/$ME/*)"

# run this script in a terminal window.
cat > $COPY << END
#! /bin/bash
# automatically generated by usbcopy

if ! mountpoint -q "$STICK" ; then
    echo The removable USB device was not found.
    read -p "Press enter to exit."
    exit
fi

echo Size of patient data in database:
du -Lsh $*
echo
echo Available space on removable USB device:
df -h "$STICK"
echo

mkdir -p "$STICK/imt/$NOWDATE/"

/usr/bin/gcp -rf $* "$STICK/imt/$NOWDATE/"
ret=\$?

umount "$STICK"
echo

if [ \$ret == 0 ]; then
    echo Data transfer succeeded.
else
    echo Data transfer returned error.
    echo Check error messages.
fi

echo You may safely remove the USB device.
read -p "Press enter to exit."
END

chmod 755 $COPY
xfce4-terminal --working-directory=$THERAPIST_HOME -e "bash -c $COPY" &
